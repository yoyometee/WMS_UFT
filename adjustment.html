<!-- Stock Adjustment Content -->
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">ปรับสต๊อก</h1>
            <p class="text-gray-600 mt-1">ปรับแก้จำนวนสต๊อกสินค้าในระบบ</p>
        </div>
        <div class="flex space-x-4">
            <button onclick="importAdjustments()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors flex items-center">
                <i class="fas fa-upload mr-2"></i>นำเข้าไฟล์
            </button>
            <button onclick="viewAdjustmentHistory()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center">
                <i class="fas fa-history mr-2"></i>ประวัติการปรับ
            </button>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">ปรับวันนี้</p>
                    <p id="todayAdjustmentCount" class="text-2xl font-bold text-gray-900">-</p>
                </div>
                <div class="bg-purple-100 rounded-full p-3">
                    <i class="fas fa-edit text-purple-600 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">ปรับเข้า</p>
                    <p id="adjustmentInCount" class="text-2xl font-bold text-gray-900">-</p>
                </div>
                <div class="bg-green-100 rounded-full p-3">
                    <i class="fas fa-plus text-green-600 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-red-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">ปรับออก</p>
                    <p id="adjustmentOutCount" class="text-2xl font-bold text-gray-900">-</p>
                </div>
                <div class="bg-red-100 rounded-full p-3">
                    <i class="fas fa-minus text-red-600 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-orange-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">รอตรวจสอบ</p>
                    <p id="pendingVerification" class="text-2xl font-bold text-gray-900">-</p>
                </div>
                <div class="bg-orange-100 rounded-full p-3">
                    <i class="fas fa-clock text-orange-600 text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Adjustment Type Selection -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">เลือกประเภทการปรับสต๊อก</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <button onclick="setAdjustmentType('item')" class="adjustment-type-btn p-6 border-2 border-gray-200 rounded-xl hover:border-purple-500 hover:bg-purple-50 transition-all text-left active" data-type="item">
                <div class="flex items-center justify-between mb-3">
                    <i class="fas fa-edit text-2xl text-purple-600"></i>
                    <div class="w-4 h-4 border-2 border-gray-300 rounded-full type-indicator"></div>
                </div>
                <h4 class="font-semibold text-gray-900">ปรับรายชิ้น</h4>
                <p class="text-sm text-gray-600 mt-1">ปรับจำนวนสินค้าเฉพาะรายการ</p>
            </button>

            <button onclick="setAdjustmentType('pallet')" class="adjustment-type-btn p-6 border-2 border-gray-200 rounded-xl hover:border-purple-500 hover:bg-purple-50 transition-all text-left" data-type="pallet">
                <div class="flex items-center justify-between mb-3">
                    <i class="fas fa-pallet text-2xl text-green-600"></i>
                    <div class="w-4 h-4 border-2 border-gray-300 rounded-full type-indicator"></div>
                </div>
                <h4 class="font-semibold text-gray-900">ปรับทั้งพาเลท</h4>
                <p class="text-sm text-gray-600 mt-1">ปรับจำนวนสินค้าทั้งพาเลท</p>
            </button>

            <button onclick="setAdjustmentType('location')" class="adjustment-type-btn p-6 border-2 border-gray-200 rounded-xl hover:border-purple-500 hover:bg-purple-50 transition-all text-left" data-type="location">
                <div class="flex items-center justify-between mb-3">
                    <i class="fas fa-map-marker-alt text-2xl text-orange-600"></i>
                    <div class="w-4 h-4 border-2 border-gray-300 rounded-full type-indicator"></div>
                </div>
                <h4 class="font-semibold text-gray-900">ปรับตามตำแหน่ง</h4>
                <p class="text-sm text-gray-600 mt-1">ปรับสินค้าในตำแหน่งเฉพาะ</p>
            </button>
        </div>
    </div>

    <!-- Item Adjustment Form -->
    <div id="itemAdjustmentForm" class="adjustment-form bg-white rounded-xl shadow-lg">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-xl font-bold text-gray-900">ปรับสต๊อกรายชิ้น</h2>
            <p class="text-gray-600 text-sm mt-1">เลือกสินค้าและระบุจำนวนที่ต้องการปรับ</p>
        </div>

        <form id="itemAdjustForm" class="p-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Left Column: Product Information -->
                <div class="space-y-6">
                    <h3 class="text-lg font-semibold text-gray-900 border-b pb-2">ข้อมูลสินค้า</h3>
                    
                    <!-- Product Search -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ค้นหาสินค้า *</label>
                        <div class="relative">
                            <input 
                                type="text" 
                                id="adjustProductSearch" 
                                placeholder="พิมพ์ SKU หรือชื่อสินค้า..." 
                                class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                autocomplete="off"
                            >
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                        <div id="adjustProductResults" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 hidden max-h-60 overflow-y-auto">
                            <!-- Search results will be populated here -->
                        </div>
                    </div>

                    <!-- Selected Product Info -->
                    <div id="adjustSelectedProductInfo" class="hidden bg-purple-50 border border-purple-200 rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-semibold text-purple-900" id="adjustSelectedProductName">-</h4>
                                <p class="text-sm text-purple-700" id="adjustSelectedProductSKU">-</p>
                                <p class="text-sm text-purple-600" id="adjustSelectedProductStock">สต๊อกปัจจุบัน: - ชิ้น</p>
                            </div>
                            <button type="button" onclick="clearAdjustSelectedProduct()" class="text-purple-600 hover:text-purple-800">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Current Stock by Location -->
                    <div id="currentStockContainer" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">สต๊อกปัจจุบันตามตำแหน่ง</label>
                        <div id="currentStockList" class="space-y-2 max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-3">
                            <!-- Current stock locations will be populated here -->
                        </div>
                    </div>

                    <!-- Adjustment Details -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ประเภทการปรับ *</label>
                            <select 
                                id="adjustmentDirection"
                                required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                onchange="updateAdjustmentCalculation()"
                            >
                                <option value="">เลือกประเภท</option>
                                <option value="in">ปรับเข้า (+)</option>
                                <option value="out">ปรับออก (-)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">จำนวนที่ปรับ (ชิ้น) *</label>
                            <input 
                                type="number" 
                                id="adjustQuantity" 
                                min="1" 
                                step="1"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                placeholder="0"
                                oninput="updateAdjustmentCalculation()"
                            >
                        </div>
                    </div>

                    <!-- Calculation Summary -->
                    <div id="adjustmentCalculation" class="hidden bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-900 mb-3">สรุปการปรับ</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">สต๊อกปัจจุบัน:</span>
                                <span class="font-medium" id="currentStockDisplay">- ชิ้น</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">จำนวนที่ปรับ:</span>
                                <span class="font-medium" id="adjustmentDisplay">- ชิ้น</span>
                            </div>
                            <div class="border-t pt-2 flex justify-between">
                                <span class="text-gray-900 font-semibold">สต๊อกหลังปรับ:</span>
                                <span class="font-bold text-lg" id="newStockDisplay">- ชิ้น</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Adjustment Information -->
                <div class="space-y-6">
                    <h3 class="text-lg font-semibold text-gray-900 border-b pb-2">ข้อมูลการปรับ</h3>
                    
                    <!-- Adjustment Reason -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">เหตุผลการปรับ *</label>
                        <select 
                            id="adjustmentReason"
                            required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                        >
                            <option value="">เลือกเหตุผล</option>
                            <option value="นับสต๊อกประจำเดือน">นับสต๊อกประจำเดือน</option>
                            <option value="แก้ไขข้อผิดพลาดในระบบ">แก้ไขข้อผิดพลาดในระบบ</option>
                            <option value="สินค้าเสียหาย">สินค้าเสียหาย</option>
                            <option value="สินค้าหาย">สินค้าหาย</option>
                            <option value="สินค้าหมดอายุ">สินค้าหมดอายุ</option>
                            <option value="ปรับปรุงข้อมูลจากการตรวจนับ">ปรับปรุงข้อมูลจากการตรวจนับ</option>
                            <option value="ยกยอดยกมา">ยกยอดยกมา</option>
                            <option value="คืนสินค้าจากลูกค้า">คืนสินค้าจากลูกค้า</option>
                            <option value="อื่น ๆ">อื่น ๆ</option>
                        </select>
                    </div>

                    <!-- Reference Document -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">เลขที่เอกสารอ้างอิง</label>
                        <input 
                            type="text" 
                            id="referenceDocument"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="เลขที่เอกสาร/ใบสั่งงาน"
                        >
                    </div>

                    <!-- Location for Adjustment -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ตำแหน่งที่ปรับ</label>
                        <select 
                            id="adjustmentLocation"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                        >
                            <option value="">เลือกตำแหน่ง (หากไม่เลือก จะปรับที่ PF-Zone)</option>
                            <!-- Locations will be loaded here -->
                        </select>
                    </div>

                    <!-- Date and Time -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">วันที่ปรับ *</label>
                            <input 
                                type="datetime-local" 
                                id="adjustmentDate"
                                required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">สถานะ</label>
                            <select 
                                id="adjustmentStatus"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            >
                                <option value="ปกติ">ปกติ</option>
                                <option value="รอตรวจสอบ">รอตรวจสอบ</option>
                                <option value="ชั่วคราว">ชั่วคราว</option>
                            </select>
                        </div>
                    </div>

                    <!-- Approval Required -->
                    <div id="approvalSection" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <div class="flex items-start">
                            <i class="fas fa-exclamation-triangle text-yellow-600 mt-1 mr-3"></i>
                            <div>
                                <h4 class="font-semibold text-yellow-900">ต้องการการอนุมัติ</h4>
                                <p class="text-sm text-yellow-700 mt-1">การปรับนี้ต้องการการอนุมัติจากผู้จัดการ</p>
                                <div class="mt-3">
                                    <label class="block text-sm font-medium text-yellow-700 mb-1">ผู้อนุมัติ</label>
                                    <select 
                                        id="approverSelect"
                                        class="w-full px-3 py-2 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                    >
                                        <option value="">เลือกผู้อนุมัติ</option>
                                        <!-- Approvers will be loaded here -->
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lot Information (if applicable) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lot/Batch (ถ้ามี)</label>
                        <input 
                            type="text" 
                            id="adjustmentLot"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="หมายเลข Lot/Batch"
                        >
                    </div>
                </div>
            </div>

            <!-- Detailed Remarks -->
            <div class="mt-8">
                <label class="block text-sm font-medium text-gray-700 mb-2">หมายเหตุรายละเอียด *</label>
                <textarea 
                    id="adjustmentRemark" 
                    rows="4"
                    required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                    placeholder="อธิบายรายละเอียดการปรับ เช่น ผลการตรวจนับ, สาเหตุที่พบ, การดำเนินการที่แนะนำ เป็นต้น"
                ></textarea>
            </div>

            <!-- Warning for Large Adjustments -->
            <div id="largeAdjustmentWarning" class="hidden mt-6 bg-red-50 border border-red-200 rounded-lg p-4">
                <div class="flex items-start">
                    <i class="fas fa-exclamation-circle text-red-600 mt-1 mr-3"></i>
                    <div>
                        <h4 class="font-semibold text-red-900">การปรับจำนวนมาก</h4>
                        <p class="text-sm text-red-700 mt-1">การปรับนี้มีจำนวนมาก กรุณาตรวจสอบความถูกต้องอีกครั้ง</p>
                        <div class="mt-3">
                            <label class="flex items-center text-sm text-red-700">
                                <input type="checkbox" id="confirmLargeAdjustment" class="rounded mr-2">
                                ยืนยันว่าข้อมูลถูกต้องและต้องการดำเนินการ
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="mt-8 flex justify-end space-x-4">
                <button 
                    type="button" 
                    onclick="resetAdjustmentForm()" 
                    class="px-8 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                >
                    ล้างฟอร์ม
                </button>
                <button 
                    type="button" 
                    onclick="previewAdjustment()" 
                    class="px-8 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors"
                >
                    ตรวจสอบก่อนบันทึก
                </button>
                <button 
                    type="submit" 
                    class="px-8 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center"
                >
                    <span id="adjustSubmitText">บันทึกการปรับสต๊อก</span>
                    <i id="adjustSubmitSpinner" class="fas fa-spinner fa-spin ml-2 hidden"></i>
                </button>
            </div>
        </form>
    </div>

    <!-- Pallet and Location Adjustment Forms (Hidden by default) -->
    <div id="palletAdjustmentForm" class="adjustment-form bg-white rounded-xl shadow-lg hidden">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-xl font-bold text-gray-900">ปรับสต๊อกทั้งพาเลท</h2>
            <p class="text-gray-600 text-sm mt-1">ปรับจำนวนสินค้าทั้งพาเลท</p>
        </div>

        <div class="p-6">
            <div class="text-center py-12 text-gray-500">
                <i class="fas fa-pallet text-4xl mb-4"></i>
                <p class="text-lg">ฟังก์ชันปรับสต๊อกทั้งพาเลทกำลังพัฒนา</p>
                <p class="text-sm">เร็ว ๆ นี้</p>
            </div>
        </div>
    </div>

    <div id="locationAdjustmentForm" class="adjustment-form bg-white rounded-xl shadow-lg hidden">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-xl font-bold text-gray-900">ปรับสต๊อกตามตำแหน่ง</h2>
            <p class="text-gray-600 text-sm mt-1">ปรับสินค้าในตำแหน่งเฉพาะ</p>
        </div>

        <div class="p-6">
            <div class="text-center py-12 text-gray-500">
                <i class="fas fa-map-marker-alt text-4xl mb-4"></i>
                <p class="text-lg">ฟังก์ชันปรับสต๊อกตามตำแหน่งกำลังพัฒนา</p>
                <p class="text-sm">เร็ว ๆ นี้</p>
            </div>
        </div>
    </div>

    <!-- Recent Adjustments -->
    <div class="bg-white rounded-xl shadow-lg">
        <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-900">การปรับล่าสุด</h2>
                <button onclick="loadRecentAdjustments()" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                    <i class="fas fa-sync-alt mr-1"></i>รีเฟรช
                </button>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">เวลา</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SKU</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">สินค้า</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ประเภท</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จำนวน</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">เหตุผล</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">สถานะ</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ผู้บันทึก</th>
                    </tr>
                </thead>
                <tbody id="recentAdjustmentsTableBody" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                            <i class="fas fa-spinner fa-spin text-xl mb-2"></i>
                            <p>กำลังโหลดข้อมูล...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div id="adjustmentPreviewModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex justify-center items-center">
    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-900">ตรวจสอบการปรับสต๊อก</h3>
                <button onclick="closePreviewModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>

        <div id="adjustmentPreviewContent" class="p-6">
            <!-- Preview content will be loaded here -->
        </div>

        <div class="p-6 border-t border-gray-200 flex justify-end space-x-4">
            <button onclick="closePreviewModal()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                แก้ไข
            </button>
            <button onclick="confirmAdjustment()" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                ยืนยันและบันทึก
            </button>
        </div>
    </div>
</div>

<style>
.adjustment-type-btn.active {
    border-color: #9333EA;
    background-color: #FAF5FF;
}

.adjustment-type-btn.active .type-indicator {
    background-color: #9333EA;
    border-color: #9333EA;
}

.adjustment-form.hidden {
    display: none;
}
</style>

<script id="adjustment-script">
let currentAdjustmentType = 'item';
let selectedAdjustProduct = null;
let currentStockAmount = 0;

function loadAdjustment() {
    document.getElementById('mainContent').innerHTML = `<?= include('adjustment'); ?>`;
    
    // Initialize adjustment page
    initializeAdjustmentPage();
}

function initializeAdjustmentPage() {
    // Setup event listeners
    setupAdjustmentEventListeners();
    
    // Set default adjustment date to now
    setDefaultAdjustmentDate();
    
    // Load initial data
    loadAdjustmentStats();
    loadRecentAdjustments();
    loadApprovers();
    
    // Show default type
    setAdjustmentType('item');
}

function setupAdjustmentEventListeners() {
    // Product search for adjustment
    const adjustProductSearch = document.getElementById('adjustProductSearch');
    if (adjustProductSearch) {
        let searchTimeout;
        adjustProductSearch.addEventListener('input', function(event) {
            const searchTerm = event.target.value.trim();
            
            if (searchTerm.length < 2) {
                hideAdjustProductResults();
                return;
            }

            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchProductsForAdjustment(searchTerm);
            }, 300);
        });

        adjustProductSearch.addEventListener('blur', function() {
            setTimeout(() => hideAdjustProductResults(), 200);
        });
    }

    // Form submission
    const itemAdjustForm = document.getElementById('itemAdjustForm');
    if (itemAdjustForm) {
        itemAdjustForm.addEventListener('submit', handleAdjustmentSubmit);
    }
}

function setDefaultAdjustmentDate() {
    const adjustmentDate = document.getElementById('adjustmentDate');
    if (adjustmentDate) {
        const now = new Date();
        const localDateTime = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
        adjustmentDate.value = localDateTime;
    }
}

function setAdjustmentType(type) {
    currentAdjustmentType = type;
    
    // Update type buttons
    document.querySelectorAll('.adjustment-type-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    document.querySelector(`[data-type="${type}"]`).classList.add('active');
    
    // Show/hide forms
    document.querySelectorAll('.adjustment-form').forEach(form => {
        form.classList.add('hidden');
    });
    
    switch(type) {
        case 'item':
            document.getElementById('itemAdjustmentForm').classList.remove('hidden');
            break;
        case 'pallet':
            document.getElementById('palletAdjustmentForm').classList.remove('hidden');
            break;
        case 'location':
            document.getElementById('locationAdjustmentForm').classList.remove('hidden');
            break;
    }
}

function searchProductsForAdjustment(searchTerm) {
    googleScriptCall('searchProducts', searchTerm)
        .then(response => {
            if (response.success) {
                displayAdjustProductResults(response.data || []);
            } else {
                console.error('Product search failed:', response.message);
                hideAdjustProductResults();
            }
        })
        .catch(error => {
            console.error('Product search error:', error);
            hideAdjustProductResults();
        });
}

function displayAdjustProductResults(products) {
    const resultsContainer = document.getElementById('adjustProductResults');
    
    if (!products || products.length === 0) {
        hideAdjustProductResults();
        return;
    }

    const resultsHTML = products.map(product => `
        <div class="px-4 py-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0" 
             onclick="selectAdjustProduct('${product.sku}', '${product.product_name}', '${product.unit}', ${product.weight_per_bag || 0}, ${product.total_pieces_normal || 0})">
            <div class="flex justify-between items-start">
                <div>
                    <p class="font-medium text-gray-900">${product.sku}</p>
                    <p class="text-sm text-gray-600">${product.product_name}</p>
                    <p class="text-xs text-gray-500">
                        ${product.unit} | ${product.weight_per_bag || 0} กก./ถุง
                    </p>
                </div>
                <div class="text-right">
                    <p class="text-sm font-medium text-blue-600">สต๊อก: ${(product.total_pieces_normal || 0).toLocaleString()}</p>
                </div>
            </div>
        </div>
    `).join('');

    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.classList.remove('hidden');
}

function hideAdjustProductResults() {
    const resultsContainer = document.getElementById('adjustProductResults');
    if (resultsContainer) {
        resultsContainer.classList.add('hidden');
    }
}

function selectAdjustProduct(sku, productName, unit, weightPerBag, currentStock) {
    selectedAdjustProduct = {
        sku,
        productName,
        unit,
        weightPerBag: parseFloat(weightPerBag) || 0,
        currentStock: parseInt(currentStock) || 0
    };

    currentStockAmount = selectedAdjustProduct.currentStock;

    // Update UI
    document.getElementById('adjustProductSearch').value = sku;
    document.getElementById('adjustSelectedProductSKU').textContent = sku;
    document.getElementById('adjustSelectedProductName').textContent = productName;
    document.getElementById('adjustSelectedProductStock').textContent = `สต๊อกปัจจุบัน: ${currentStock.toLocaleString()} ชิ้น`;
    
    document.getElementById('adjustSelectedProductInfo').classList.remove('hidden');
    hideAdjustProductResults();
    
    // Load current stock by location
    loadCurrentStockByLocation(sku);
    
    // Update calculation
    updateAdjustmentCalculation();
}

function clearAdjustSelectedProduct() {
    selectedAdjustProduct = null;
    currentStockAmount = 0;
    
    document.getElementById('adjustProductSearch').value = '';
    document.getElementById('adjustSelectedProductInfo').classList.add('hidden');
    document.getElementById('currentStockContainer').classList.add('hidden');
    document.getElementById('adjustmentCalculation').classList.add('hidden');
    
    // Clear form fields
    document.getElementById('adjustQuantity').value = '';
    document.getElementById('adjustmentDirection').value = '';
}

function loadCurrentStockByLocation(sku) {
    // For now, show sample stock locations
    // In production, this would query actual stock by location
    const sampleStock = [
        { location_id: 'A01-01-001', stock: Math.floor(currentStockAmount * 0.6), zone: 'Selective Rack' },
        { location_id: 'PF-01', stock: Math.floor(currentStockAmount * 0.3), zone: 'Pick Face' },
        { location_id: 'A01-02-003', stock: Math.floor(currentStockAmount * 0.1), zone: 'Selective Rack' }
    ];
    
    displayCurrentStockByLocation(sampleStock);
}

function displayCurrentStockByLocation(stockData) {
    const container = document.getElementById('currentStockList');
    
    if (!stockData || stockData.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">ไม่พบสต๊อกในคลัง</p>';
        document.getElementById('currentStockContainer').classList.remove('hidden');
        return;
    }
    
    const stockHTML = stockData.map(stock => `
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
            <div>
                <p class="font-medium text-gray-900">${stock.location_id}</p>
                <p class="text-sm text-gray-600">${stock.zone}</p>
            </div>
            <div class="text-right">
                <p class="text-lg font-semibold text-blue-600">${stock.stock.toLocaleString()}</p>
                <p class="text-xs text-gray-500">ชิ้น</p>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = stockHTML;
    document.getElementById('currentStockContainer').classList.remove('hidden');
}

function updateAdjustmentCalculation() {
    const direction = document.getElementById('adjustmentDirection').value;
    const quantity = parseFloat(document.getElementById('adjustQuantity').value) || 0;
    
    if (!selectedAdjustProduct || !direction || quantity <= 0) {
        document.getElementById('adjustmentCalculation').classList.add('hidden');
        document.getElementById('largeAdjustmentWarning').classList.add('hidden');
        return;
    }
    
    const currentStock = selectedAdjustProduct.currentStock;
    let adjustmentAmount = quantity;
    let newStock = currentStock;
    
    if (direction === 'in') {
        newStock = currentStock + quantity;
        adjustmentAmount = quantity;
    } else if (direction === 'out') {
        newStock = currentStock - quantity;
        adjustmentAmount = -quantity;
    }
    
    // Update display
    document.getElementById('currentStockDisplay').textContent = `${currentStock.toLocaleString()} ชิ้น`;
    document.getElementById('adjustmentDisplay').textContent = `${adjustmentAmount > 0 ? '+' : ''}${adjustmentAmount.toLocaleString()} ชิ้น`;
    document.getElementById('newStockDisplay').textContent = `${newStock.toLocaleString()} ชิ้น`;
    
    // Color coding for new stock
    const newStockEl = document.getElementById('newStockDisplay');
    if (newStock < 0) {
        newStockEl.className = 'font-bold text-lg text-red-600';
    } else if (newStock < currentStock * 0.1) {
        newStockEl.className = 'font-bold text-lg text-orange-600';
    } else {
        newStockEl.className = 'font-bold text-lg text-green-600';
    }
    
    document.getElementById('adjustmentCalculation').classList.remove('hidden');
    
    // Show warning for large adjustments
    const adjustmentPercentage = Math.abs(adjustmentAmount) / currentStock;
    if (adjustmentPercentage > 0.2 || Math.abs(adjustmentAmount) > 1000) {
        document.getElementById('largeAdjustmentWarning').classList.remove('hidden');
    } else {
        document.getElementById('largeAdjustmentWarning').classList.add('hidden');
    }
    
    // Show approval section for significant adjustments
    if (adjustmentPercentage > 0.5 || Math.abs(adjustmentAmount) > 5000) {
        document.getElementById('approvalSection').classList.remove('hidden');
    } else {
        document.getElementById('approvalSection').classList.add('hidden');
    }
}

function previewAdjustment() {
    if (!validateAdjustmentForm()) {
        return;
    }
    
    const adjustmentData = collectAdjustmentData();
    displayAdjustmentPreview(adjustmentData);
    document.getElementById('adjustmentPreviewModal').classList.remove('hidden');
}

function validateAdjustmentForm() {
    if (!selectedAdjustProduct) {
        showMessage('กรุณาเลือกสินค้าก่อน', 'error');
        return false;
    }
    
    const direction = document.getElementById('adjustmentDirection').value;
    const quantity = parseFloat(document.getElementById('adjustQuantity').value) || 0;
    const reason = document.getElementById('adjustmentReason').value;
    const remark = document.getElementById('adjustmentRemark').value.trim();
    
    if (!direction) {
        showMessage('กรุณาเลือกประเภทการปรับ', 'error');
        return false;
    }
    
    if (quantity <= 0) {
        showMessage('กรุณากรอกจำนวนที่ปรับที่ถูกต้อง', 'error');
        return false;
    }
    
    if (!reason) {
        showMessage('กรุณาเลือกเหตุผลการปรับ', 'error');
        return false;
    }
    
    if (!remark) {
        showMessage('กรุณากรอกหมายเหตุรายละเอียด', 'error');
        return false;
    }
    
    // Check for negative stock
    const newStock = direction === 'in' 
        ? selectedAdjustProduct.currentStock + quantity 
        : selectedAdjustProduct.currentStock - quantity;
    
    if (newStock < 0) {
        showMessage('การปรับนี้จะทำให้สต๊อกติดลบ กรุณาตรวจสอบจำนวน', 'error');
        return false;
    }
    
    // Check large adjustment confirmation
    const adjustmentPercentage = Math.abs(quantity) / selectedAdjustProduct.currentStock;
    if ((adjustmentPercentage > 0.2 || Math.abs(quantity) > 1000)) {
        const confirmed = document.getElementById('confirmLargeAdjustment').checked;
        if (!confirmed) {
            showMessage('กรุณายืนยันการปรับจำนวนมาก', 'error');
            return false;
        }
    }
    
    return true;
}

function collectAdjustmentData() {
    const direction = document.getElementById('adjustmentDirection').value;
    const quantity = parseFloat(document.getElementById('adjustQuantity').value) || 0;
    const adjustmentAmount = direction === 'in' ? quantity : -quantity;
    const newStock = selectedAdjustProduct.currentStock + adjustmentAmount;
    
    return {
        product: selectedAdjustProduct,
        direction: direction,
        quantity: quantity,
        adjustmentAmount: adjustmentAmount,
        newStock: newStock,
        reason: document.getElementById('adjustmentReason').value,
        referenceDocument: document.getElementById('referenceDocument').value || null,
        location: document.getElementById('adjustmentLocation').value || 'PF-Zone',
        date: document.getElementById('adjustmentDate').value,
        status: document.getElementById('adjustmentStatus').value,
        lot: document.getElementById('adjustmentLot').value || null,
        remark: document.getElementById('adjustmentRemark').value,
        approver: document.getElementById('approverSelect').value || null
    };
}

function displayAdjustmentPreview(data) {
    const previewContent = document.getElementById('adjustmentPreviewContent');
    
    const previewHTML = `
        <div class="space-y-6">
            <!-- Product Information -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-semibold text-gray-900 mb-3">ข้อมูลสินค้า</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-600">SKU:</p>
                        <p class="font-medium">${data.product.sku}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">ชื่อสินค้า:</p>
                        <p class="font-medium">${data.product.productName}</p>
                    </div>
                </div>
            </div>
            
            <!-- Adjustment Summary -->
            <div class="bg-blue-50 rounded-lg p-4">
                <h4 class="font-semibold text-gray-900 mb-3">สรุปการปรับ</h4>
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div>
                        <p class="text-sm text-gray-600">สต๊อกปัจจุบัน</p>
                        <p class="text-xl font-bold text-gray-900">${data.product.currentStock.toLocaleString()}</p>
                        <p class="text-xs text-gray-500">ชิ้น</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">จำนวนที่ปรับ</p>
                        <p class="text-xl font-bold ${data.adjustmentAmount > 0 ? 'text-green-600' : 'text-red-600'}">
                            ${data.adjustmentAmount > 0 ? '+' : ''}${data.adjustmentAmount.toLocaleString()}
                        </p>
                        <p class="text-xs text-gray-500">ชิ้น</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">สต๊อกหลังปรับ</p>
                        <p class="text-xl font-bold ${data.newStock >= 0 ? 'text-green-600' : 'text-red-600'}">
                            ${data.newStock.toLocaleString()}
                        </p>
                        <p class="text-xs text-gray-500">ชิ้น</p>
                    </div>
                </div>
            </div>
            
            <!-- Details -->
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-600">เหตุผล:</p>
                        <p class="font-medium">${data.reason}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">ตำแหน่ง:</p>
                        <p class="font-medium">${data.location}</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-600">วันที่ปรับ:</p>
                        <p class="font-medium">${new Date(data.date).toLocaleString('th-TH')}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">สถานะ:</p>
                        <p class="font-medium">${data.status}</p>
                    </div>
                </div>
                
                ${data.referenceDocument ? `
                    <div>
                        <p class="text-sm text-gray-600">เลขที่เอกสารอ้างอิง:</p>
                        <p class="font-medium">${data.referenceDocument}</p>
                    </div>
                ` : ''}
                
                ${data.lot ? `
                    <div>
                        <p class="text-sm text-gray-600">Lot/Batch:</p>
                        <p class="font-medium">${data.lot}</p>
                    </div>
                ` : ''}
                
                <div>
                    <p class="text-sm text-gray-600">หมายเหตุ:</p>
                    <p class="font-medium">${data.remark}</p>
                </div>
                
                ${data.approver ? `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                        <p class="text-sm text-yellow-700">ต้องการการอนุมัติ</p>
                        <p class="font-medium text-yellow-900">ผู้อนุมัติ: ${data.approver}</p>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
    
    previewContent.innerHTML = previewHTML;
}

function closePreviewModal() {
    document.getElementById('adjustmentPreviewModal').classList.add('hidden');
}

function confirmAdjustment() {
    closePreviewModal();
    handleAdjustmentSubmit(null, true);
}

function handleAdjustmentSubmit(event, fromPreview = false) {
    if (event) {
        event.preventDefault();
    }
    
    if (!fromPreview && !validateAdjustmentForm()) {
        return;
    }
    
    // Show loading state
    setAdjustSubmitLoading(true);
    
    const adjustmentData = collectAdjustmentData();
    
    // Prepare transaction data
    const transactionData = {
        sku: adjustmentData.product.sku,
        main_type: adjustmentData.direction === 'in' ? 'ปรับสต๊อก' : 'ปรับสต๊อก',
        sub_type: adjustmentData.direction === 'in' ? 'ปรับเข้า' : 'ปรับออก',
        pieces: adjustmentData.adjustmentAmount,
        weight: adjustmentData.adjustmentAmount * adjustmentData.product.weightPerBag,
        location_id: adjustmentData.location,
        lot_document: adjustmentData.referenceDocument,
        remark: `${adjustmentData.reason} - ${adjustmentData.remark}`,
        status: adjustmentData.status
    };
    
    // Submit transaction
    googleScriptCall('createTransaction', transactionData)
        .then(response => {
            if (response.success) {
                showMessage('บันทึกการปรับสต๊อกเรียบร้อยแล้ว Tags ID: ' + response.tags_id, 'success');
                resetAdjustmentForm();
                loadAdjustmentStats();
                loadRecentAdjustments();
            } else {
                showMessage('เกิดข้อผิดพลาด: ' + response.message, 'error');
            }
        })
        .catch(error => {
            console.error('Adjustment submission error:', error);
            showMessage('เกิดข้อผิดพลาดในการเชื่อมต่อ', 'error');
        })
        .finally(() => {
            setAdjustSubmitLoading(false);
        });
}

function setAdjustSubmitLoading(isLoading) {
    const button = document.querySelector('#itemAdjustForm button[type="submit"]');
    const text = document.getElementById('adjustSubmitText');
    const spinner = document.getElementById('adjustSubmitSpinner');
    
    if (button) button.disabled = isLoading;
    if (text) text.textContent = isLoading ? 'กำลังบันทึก...' : 'บันทึกการปรับสต๊อก';
    if (spinner) {
        if (isLoading) {
            spinner.classList.remove('hidden');
        } else {
            spinner.classList.add('hidden');
        }
    }
}

function resetAdjustmentForm() {
    // Clear form
    document.getElementById('itemAdjustForm').reset();
    
    // Clear selected product
    clearAdjustSelectedProduct();
    
    // Reset default date
    setDefaultAdjustmentDate();
    
    // Hide warnings
    document.getElementById('largeAdjustmentWarning').classList.add('hidden');
    document.getElementById('approvalSection').classList.add('hidden');
    
    showMessage('รีเซ็ตฟอร์มเรียบร้อย', 'success');
}

function loadAdjustmentStats() {
    // For now, show static data
    document.getElementById('todayAdjustmentCount').textContent = '3';
    document.getElementById('adjustmentInCount').textContent = '2';
    document.getElementById('adjustmentOutCount').textContent = '1';
    document.getElementById('pendingVerification').textContent = '0';
}

function loadRecentAdjustments() {
    googleScriptCall('getTransactions', { 
        main_type: 'ปรับสต๊อก', 
        limit: 10 
    })
        .then(response => {
            if (response.success) {
                displayRecentAdjustments(response.data || []);
            } else {
                console.error('Failed to load recent adjustments:', response.message);
                displayAdjustmentsError();
            }
        })
        .catch(error => {
            console.error('Recent adjustments loading error:', error);
            displayAdjustmentsError();
        });
}

function displayRecentAdjustments(adjustments) {
    const tbody = document.getElementById('recentAdjustmentsTableBody');
    
    if (!adjustments || adjustments.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                    <i class="fas fa-inbox text-xl mb-2"></i>
                    <p>ไม่มีการปรับล่าสุด</p>
                </td>
            </tr>
        `;
        return;
    }

    const rows = adjustments.map(adjustment => {
        const createdAt = new Date(adjustment.created_at);
        const timeStr = createdAt.toLocaleTimeString('th-TH', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });

        const pieces = adjustment.pieces || 0;
        const isIncrease = pieces > 0;

        return `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${timeStr}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                    ${adjustment.products?.sku || 'N/A'}
                </td>
                <td class="px-6 py-4 text-sm text-gray-900">
                    ${adjustment.products?.product_name || 'N/A'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${isIncrease ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                        ${adjustment.transaction_types?.sub_type || 'N/A'}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${isIncrease ? 'text-green-600' : 'text-red-600'}">
                    ${isIncrease ? '+' : ''}${pieces.toLocaleString()} ชิ้น
                </td>
                <td class="px-6 py-4 text-sm text-gray-900">
                    ${(adjustment.remark || '').split(' - ')[0] || 'N/A'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                        ${adjustment.status || 'ปกติ'}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${adjustment.users?.full_name || adjustment.created_by_name || 'N/A'}
                </td>
            </tr>
        `;
    }).join('');

    tbody.innerHTML = rows;
}

function displayAdjustmentsError() {
    const tbody = document.getElementById('recentAdjustmentsTableBody');
    tbody.innerHTML = `
        <tr>
            <td colspan="8" class="px-6 py-8 text-center text-red-500">
                <i class="fas fa-exclamation-triangle text-xl mb-2"></i>
                <p>เกิดข้อผิดพลาดในการโหลดข้อมูล</p>
                <button onclick="loadRecentAdjustments()" class="mt-2 px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                    ลองใหม่
                </button>
            </td>
        </tr>
    `;
}

function loadApprovers() {
    // For now, use static data
    const approverSelect = document.getElementById('approverSelect');
    if (approverSelect) {
        approverSelect.innerHTML = `
            <option value="">เลือกผู้อนุมัติ</option>
            <option value="WH001">เมธี เจริญสุข (ผู้จัดการ)</option>
            <option value="WH003">สมชาย ใจดี (ผู้ช่วยผู้จัดการ)</option>
        `;
    }
}

function importAdjustments() {
    showMessage('ฟังก์ชันนำเข้าไฟล์ปรับสต๊อกกำลังพัฒนา', 'info');
}

function viewAdjustmentHistory() {
    loadPage('transactions');
}
</script>
