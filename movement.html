<!-- Movement Operations Content -->
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">ย้ายสินค้า</h1>
            <p class="text-gray-600 mt-1">จัดการการย้ายสินค้าระหว่างตำแหน่งต่าง ๆ ในคลัง</p>
        </div>
        <div class="flex space-x-4">
            <button onclick="bulkMovement()" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition-colors flex items-center">
                <i class="fas fa-layer-group mr-2"></i>ย้ายหลายรายการ
            </button>
            <button onclick="viewMovementHistory()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center">
                <i class="fas fa-history mr-2"></i>ประวัติการย้าย
            </button>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-orange-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">ย้ายวันนี้</p>
                    <p id="todayMovementCount" class="text-2xl font-bold text-gray-900">-</p>
                </div>
                <div class="bg-orange-100 rounded-full p-3">
                    <i class="fas fa-exchange-alt text-orange-600 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">พื้นที่ว่าง</p>
                    <p id="availableLocations" class="text-2xl font-bold text-gray-900">-</p>
                </div>
                <div class="bg-blue-100 rounded-full p-3">
                    <i class="fas fa-warehouse text-blue-600 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">พาเลทย้าย</p>
                    <p id="palletsMoved" class="text-2xl font-bold text-gray-900">-</p>
                </div>
                <div class="bg-green-100 rounded-full p-3">
                    <i class="fas fa-pallet text-green-600 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-red-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">รอจัดเรียง</p>
                    <p id="pendingReorganize" class="text-2xl font-bold text-gray-900">-</p>
                </div>
                <div class="bg-red-100 rounded-full p-3">
                    <i class="fas fa-sort text-red-600 text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Movement Type Selection -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">เลือกประเภทการย้าย</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <button onclick="setMovementType('item')" class="movement-type-btn p-6 border-2 border-gray-200 rounded-xl hover:border-orange-500 hover:bg-orange-50 transition-all text-left active" data-type="item">
                <div class="flex items-center justify-between mb-3">
                    <i class="fas fa-box text-2xl text-orange-600"></i>
                    <div class="w-4 h-4 border-2 border-gray-300 rounded-full type-indicator"></div>
                </div>
                <h4 class="font-semibold text-gray-900">ย้ายรายชิ้น</h4>
                <p class="text-sm text-gray-600 mt-1">ย้ายสินค้าบางส่วนจากตำแหน่งหนึ่งไปอีกตำแหน่งหนึ่ง</p>
            </button>

            <button onclick="setMovementType('pallet')" class="movement-type-btn p-6 border-2 border-gray-200 rounded-xl hover:border-orange-500 hover:bg-orange-50 transition-all text-left" data-type="pallet">
                <div class="flex items-center justify-between mb-3">
                    <i class="fas fa-pallet text-2xl text-green-600"></i>
                    <div class="w-4 h-4 border-2 border-gray-300 rounded-full type-indicator"></div>
                </div>
                <h4 class="font-semibold text-gray-900">ย้ายทั้งพาเลท</h4>
                <p class="text-sm text-gray-600 mt-1">ย้ายพาเลททั้งใบไปยังตำแหน่งใหม่</p>
            </button>

            <button onclick="setMovementType('zone')" class="movement-type-btn p-6 border-2 border-gray-200 rounded-xl hover:border-orange-500 hover:bg-orange-50 transition-all text-left" data-type="zone">
                <div class="flex items-center justify-between mb-3">
                    <i class="fas fa-arrows-alt text-2xl text-purple-600"></i>
                    <div class="w-4 h-4 border-2 border-gray-300 rounded-full type-indicator"></div>
                </div>
                <h4 class="font-semibold text-gray-900">ย้ายข้ามโซน</h4>
                <p class="text-sm text-gray-600 mt-1">ย้ายสินค้าระหว่างโซนต่าง ๆ เช่น Pick Face ไป Storage</p>
            </button>
        </div>
    </div>

    <!-- Item Movement Form -->
    <div id="itemMovementForm" class="movement-form bg-white rounded-xl shadow-lg">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-xl font-bold text-gray-900">ย้ายสินค้ารายชิ้น</h2>
            <p class="text-gray-600 text-sm mt-1">เลือกสินค้าและตำแหน่งต้นทางเพื่อย้ายไปยังตำแหน่งปลายทาง</p>
        </div>

        <form id="itemMoveForm" class="p-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Left Column: Source Information -->
                <div class="space-y-6">
                    <h3 class="text-lg font-semibold text-gray-900 border-b pb-2">ข้อมูลต้นทาง</h3>
                    
                    <!-- Product Search -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ค้นหาสินค้า *</label>
                        <div class="relative">
                            <input 
                                type="text" 
                                id="moveProductSearch" 
                                placeholder="พิมพ์ SKU หรือชื่อสินค้า..." 
                                class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                autocomplete="off"
                            >
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                        <div id="moveProductResults" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 hidden max-h-60 overflow-y-auto">
                            <!-- Search results will be populated here -->
                        </div>
                    </div>

                    <!-- Selected Product Info -->
                    <div id="moveSelectedProductInfo" class="hidden bg-orange-50 border border-orange-200 rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-semibold text-orange-900" id="moveSelectedProductName">-</h4>
                                <p class="text-sm text-orange-700" id="moveSelectedProductSKU">-</p>
                            </div>
                            <button type="button" onclick="clearMoveSelectedProduct()" class="text-orange-600 hover:text-orange-800">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Source Location Selection -->
                    <div id="sourceLocationContainer" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">เลือกตำแหน่งต้นทาง *</label>
                        <div id="sourceLocationsList" class="space-y-2 max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-3">
                            <!-- Source locations will be populated here -->
                        </div>
                    </div>

                    <!-- Selected Source Info -->
                    <div id="selectedSourceInfo" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h4 class="font-semibold text-blue-900 mb-2">ตำแหน่งต้นทาง</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-blue-700">ตำแหน่ง:</span>
                                <span class="font-medium" id="sourceLocationId">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-blue-700">สต๊อกคงเหลือ:</span>
                                <span class="font-medium" id="sourceStockAmount">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-blue-700">Pallet ID:</span>
                                <span class="font-medium" id="sourcePalletId">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quantity to Move -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">จำนวนที่ย้าย (ชิ้น) *</label>
                            <input 
                                type="number" 
                                id="movePieces" 
                                min="1" 
                                step="1"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                placeholder="0"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">น้ำหนักที่ย้าย (กก.)</label>
                            <input 
                                type="number" 
                                id="moveWeight" 
                                step="0.001"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent bg-gray-50"
                                placeholder="0.000"
                                readonly
                            >
                        </div>
                    </div>
                </div>

                <!-- Right Column: Destination Information -->
                <div class="space-y-6">
                    <h3 class="text-lg font-semibold text-gray-900 border-b pb-2">ข้อมูลปลายทาง</h3>
                    
                    <!-- Zone Filter -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">กรองตามโซน</label>
                        <select 
                            id="destinationZoneFilter"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                            onchange="filterDestinationLocations()"
                        >
                            <option value="">ทุกโซน</option>
                            <option value="Selective Rack">Selective Rack</option>
                            <option value="Pick Face">Pick Face</option>
                            <option value="Premium">Premium</option>
                            <option value="Receiving">Receiving</option>
                            <option value="Dispatch">Dispatch</option>
                        </select>
                    </div>

                    <!-- Available Destination Locations -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">เลือกตำแหน่งปลายทาง *</label>
                        <div id="destinationLocationsList" class="space-y-2 max-h-60 overflow-y-auto border border-gray-200 rounded-lg p-3">
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-spinner fa-spin text-xl mb-2"></i>
                                <p>กำลังโหลดตำแหน่งที่ว่าง...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Selected Destination Info -->
                    <div id="selectedDestinationInfo" class="hidden bg-green-50 border border-green-200 rounded-lg p-4">
                        <h4 class="font-semibold text-green-900 mb-2">ตำแหน่งปลายทาง</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-green-700">ตำแหน่ง:</span>
                                <span class="font-medium" id="destinationLocationId">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-green-700">โซน:</span>
                                <span class="font-medium" id="destinationZone">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-green-700">ความจุสูงสุด:</span>
                                <span class="font-medium" id="destinationCapacity">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-green-700">สถานะ:</span>
                                <span class="font-medium text-green-600" id="destinationStatus">ว่าง</span>
                            </div>
                        </div>
                    </div>

                    <!-- Movement Reason -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">เหตุผลในการย้าย *</label>
                        <select 
                            id="movementReason"
                            required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                        >
                            <option value="">เลือกเหตุผล</option>
                            <option value="จัดเรียงสินค้า">จัดเรียงสินค้า</option>
                            <option value="เพิ่มประสิทธิภาพการเบิก">เพิ่มประสิทธิภาพการเบิก</option>
                            <option value="พื้นที่เต็ม">พื้นที่เต็ม</option>
                            <option value="บำรุงรักษาพื้นที่">บำรุงรักษาพื้นที่</option>
                            <option value="เตรียมการจัดส่ง">เตรียมการจัดส่ง</option>
                            <option value="ปรับแผนการจัดเก็บ">ปรับแผนการจัดเก็บ</option>
                            <option value="อื่น ๆ">อื่น ๆ</option>
                        </select>
                    </div>

                    <!-- New Pallet ID (if needed) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Pallet ID ใหม่ (ถ้าต้องการเปลี่ยน)</label>
                        <input 
                            type="text" 
                            id="newPalletId"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                            placeholder="ใส่ Pallet ID ใหม่หากต้องการเปลี่ยน"
                        >
                    </div>
                </div>
            </div>

            <!-- Movement Summary -->
            <div id="movementSummary" class="hidden mt-8 bg-gray-50 border border-gray-200 rounded-lg p-6">
                <h4 class="font-semibold text-gray-900 mb-4">สรุปการย้าย</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                    <div class="bg-blue-100 rounded-lg p-4">
                        <i class="fas fa-map-marker-alt text-blue-600 text-2xl mb-2"></i>
                        <p class="text-sm text-blue-700">จาก</p>
                        <p class="font-semibold text-blue-900" id="summaryFrom">-</p>
                    </div>
                    <div class="bg-orange-100 rounded-lg p-4">
                        <i class="fas fa-boxes text-orange-600 text-2xl mb-2"></i>
                        <p class="text-sm text-orange-700">จำนวน</p>
                        <p class="font-semibold text-orange-900" id="summaryQuantity">-</p>
                    </div>
                    <div class="bg-green-100 rounded-lg p-4">
                        <i class="fas fa-map-marker-alt text-green-600 text-2xl mb-2"></i>
                        <p class="text-sm text-green-700">ไป</p>
                        <p class="font-semibold text-green-900" id="summaryTo">-</p>
                    </div>
                </div>
            </div>

            <!-- Remarks -->
            <div class="mt-8">
                <label class="block text-sm font-medium text-gray-700 mb-2">หมายเหตุ</label>
                <textarea 
                    id="moveRemark" 
                    rows="3"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                    placeholder="ข้อมูลเพิ่มเติมเกี่ยวกับการย้าย"
                ></textarea>
            </div>

            <!-- Form Actions -->
            <div class="mt-8 flex justify-end space-x-4">
                <button 
                    type="button" 
                    onclick="resetMovementForm()" 
                    class="px-8 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                >
                    ล้างฟอร์ม
                </button>
                <button 
                    type="submit" 
                    class="px-8 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors flex items-center"
                >
                    <span id="moveSubmitText">ดำเนินการย้ายสินค้า</span>
                    <i id="moveSubmitSpinner" class="fas fa-spinner fa-spin ml-2 hidden"></i>
                </button>
            </div>
        </form>
    </div>

    <!-- Pallet Movement Form (Hidden by default) -->
    <div id="palletMovementForm" class="movement-form bg-white rounded-xl shadow-lg hidden">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-xl font-bold text-gray-900">ย้ายทั้งพาเลท</h2>
            <p class="text-gray-600 text-sm mt-1">ย้ายพาเลททั้งใบไปยังตำแหน่งใหม่</p>
        </div>

        <div class="p-6">
            <div class="text-center py-12 text-gray-500">
                <i class="fas fa-pallet text-4xl mb-4"></i>
                <p class="text-lg">ฟังก์ชันย้ายทั้งพาเลทกำลังพัฒนา</p>
                <p class="text-sm">เร็ว ๆ นี้</p>
            </div>
        </div>
    </div>

    <!-- Zone Movement Form (Hidden by default) -->
    <div id="zoneMovementForm" class="movement-form bg-white rounded-xl shadow-lg hidden">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-xl font-bold text-gray-900">ย้ายข้ามโซน</h2>
            <p class="text-gray-600 text-sm mt-1">ย้ายสินค้าระหว่างโซนต่าง ๆ เช่น Storage ไป Pick Face</p>
        </div>

        <div class="p-6">
            <div class="text-center py-12 text-gray-500">
                <i class="fas fa-arrows-alt text-4xl mb-4"></i>
                <p class="text-lg">ฟังก์ชันย้ายข้ามโซนกำลังพัฒนา</p>
                <p class="text-sm">เร็ว ๆ นี้</p>
            </div>
        </div>
    </div>

    <!-- Recent Movements -->
    <div class="bg-white rounded-xl shadow-lg">
        <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-900">การย้ายล่าสุด</h2>
                <button onclick="loadRecentMovements()" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                    <i class="fas fa-sync-alt mr-1"></i>รีเฟรช
                </button>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">เวลา</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SKU</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">สินค้า</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จาก</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ไป</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จำนวน</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">เหตุผล</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ผู้บันทึก</th>
                    </tr>
                </thead>
                <tbody id="recentMovementsTableBody" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                            <i class="fas fa-spinner fa-spin text-xl mb-2"></i>
                            <p>กำลังโหลดข้อมูล...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
.movement-type-btn.active {
    border-color: #EA580C;
    background-color: #FFF7ED;
}

.movement-type-btn.active .type-indicator {
    background-color: #EA580C;
    border-color: #EA580C;
}

.movement-form.hidden {
    display: none;
}

.source-location-item,
.destination-location-item {
    border: 2px solid #E5E7EB;
    transition: all 0.2s;
    cursor: pointer;
}

.source-location-item:hover,
.destination-location-item:hover {
    border-color: #EA580C;
    background-color: #FFF7ED;
}

.source-location-item.selected {
    border-color: #3B82F6;
    background-color: #EFF6FF;
}

.destination-location-item.selected {
    border-color: #10B981;
    background-color: #ECFDF5;
}
</style>

<script id="movement-script">
let currentMovementType = 'item';
let selectedMoveProduct = null;
let selectedSourceLocation = null;
let selectedDestinationLocation = null;
let availableDestinations = [];

function loadMovement() {
    document.getElementById('mainContent').innerHTML = `<?= include('movement'); ?>`;
    
    // Initialize movement page
    initializeMovementPage();
}

function initializeMovementPage() {
    // Setup event listeners
    setupMovementEventListeners();
    
    // Load initial data
    loadMovementStats();
    loadRecentMovements();
    loadDestinationLocations();
    
    // Show default type
    setMovementType('item');
}

function setupMovementEventListeners() {
    // Product search for movement
    const moveProductSearch = document.getElementById('moveProductSearch');
    if (moveProductSearch) {
        let searchTimeout;
        moveProductSearch.addEventListener('input', function(event) {
            const searchTerm = event.target.value.trim();
            
            if (searchTerm.length < 2) {
                hideMoveProductResults();
                return;
            }

            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchProductsForMovement(searchTerm);
            }, 300);
        });

        moveProductSearch.addEventListener('blur', function() {
            setTimeout(() => hideMoveProductResults(), 200);
        });
    }

    // Quantity input for auto-calculation
    const movePiecesInput = document.getElementById('movePieces');
    if (movePiecesInput) {
        movePiecesInput.addEventListener('input', function() {
            autoCalculateMovementWeight();
            updateMovementSummary();
        });
    }

    // Form submission
    const itemMoveForm = document.getElementById('itemMoveForm');
    if (itemMoveForm) {
        itemMoveForm.addEventListener('submit', handleMovementSubmit);
    }
}

function setMovementType(type) {
    currentMovementType = type;
    
    // Update type buttons
    document.querySelectorAll('.movement-type-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    document.querySelector(`[data-type="${type}"]`).classList.add('active');
    
    // Show/hide forms
    document.querySelectorAll('.movement-form').forEach(form => {
        form.classList.add('hidden');
    });
    
    switch(type) {
        case 'item':
            document.getElementById('itemMovementForm').classList.remove('hidden');
            break;
        case 'pallet':
            document.getElementById('palletMovementForm').classList.remove('hidden');
            break;
        case 'zone':
            document.getElementById('zoneMovementForm').classList.remove('hidden');
            break;
    }
}

function searchProductsForMovement(searchTerm) {
    googleScriptCall('searchProducts', searchTerm)
        .then(response => {
            if (response.success) {
                displayMoveProductResults(response.data || []);
            } else {
                console.error('Product search failed:', response.message);
                hideMoveProductResults();
            }
        })
        .catch(error => {
            console.error('Product search error:', error);
            hideMoveProductResults();
        });
}

function displayMoveProductResults(products) {
    const resultsContainer = document.getElementById('moveProductResults');
    
    if (!products || products.length === 0) {
        hideMoveProductResults();
        return;
    }

    const resultsHTML = products.map(product => `
        <div class="px-4 py-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0" 
             onclick="selectMoveProduct('${product.sku}', '${product.product_name}', '${product.unit}', ${product.weight_per_bag || 0})">
            <div class="flex justify-between items-start">
                <div>
                    <p class="font-medium text-gray-900">${product.sku}</p>
                    <p class="text-sm text-gray-600">${product.product_name}</p>
                    <p class="text-xs text-gray-500">
                        ${product.unit} | ${product.weight_per_bag || 0} กก./ถุง
                    </p>
                </div>
                <div class="text-right">
                    <p class="text-sm font-medium text-green-600">สต๊อกทั้งหมด: ${(product.total_pieces_normal || 0).toLocaleString()}</p>
                </div>
            </div>
        </div>
    `).join('');

    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.classList.remove('hidden');
}

function hideMoveProductResults() {
    const resultsContainer = document.getElementById('moveProductResults');
    if (resultsContainer) {
        resultsContainer.classList.add('hidden');
    }
}

function selectMoveProduct(sku, productName, unit, weightPerBag) {
    selectedMoveProduct = {
        sku,
        productName,
        unit,
        weightPerBag: parseFloat(weightPerBag) || 0
    };

    // Update UI
    document.getElementById('moveProductSearch').value = sku;
    document.getElementById('moveSelectedProductSKU').textContent = sku;
    document.getElementById('moveSelectedProductName').textContent = productName;
    
    document.getElementById('moveSelectedProductInfo').classList.remove('hidden');
    hideMoveProductResults();
    
    // Load source locations for this product
    loadSourceLocations(sku);
}

function clearMoveSelectedProduct() {
    selectedMoveProduct = null;
    selectedSourceLocation = null;
    selectedDestinationLocation = null;
    
    document.getElementById('moveProductSearch').value = '';
    document.getElementById('moveSelectedProductInfo').classList.add('hidden');
    document.getElementById('sourceLocationContainer').classList.add('hidden');
    document.getElementById('selectedSourceInfo').classList.add('hidden');
    document.getElementById('selectedDestinationInfo').classList.add('hidden');
    document.getElementById('movementSummary').classList.add('hidden');
    
    // Clear form fields
    document.getElementById('movePieces').value = '';
    document.getElementById('moveWeight').value = '';
}

function loadSourceLocations(sku) {
    // For now, show sample locations with stock
    // In production, this would query actual locations with stock for this SKU
    const sampleLocations = [
        { location_id: 'A01-01-001', stock: 100, pallet_id: 'ATG2500001234', zone: 'Selective Rack' },
        { location_id: 'A01-02-003', stock: 250, pallet_id: 'ATG2500001235', zone: 'Selective Rack' },
        { location_id: 'PF-01', stock: 50, pallet_id: null, zone: 'Pick Face' }
    ];
    
    displaySourceLocations(sampleLocations);
}

function displaySourceLocations(locations) {
    const container = document.getElementById('sourceLocationsList');
    
    if (!locations || locations.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">ไม่พบสต๊อกในคลัง</p>';
        document.getElementById('sourceLocationContainer').classList.remove('hidden');
        return;
    }
    
    const locationsHTML = locations.map(location => `
        <div class="source-location-item p-4 rounded-lg" 
             onclick="selectSourceLocation('${location.location_id}', ${location.stock}, '${location.pallet_id || 'N/A'}', '${location.zone}')"
             data-location="${location.location_id}">
            <div class="flex justify-between items-center">
                <div>
                    <p class="font-medium text-gray-900">${location.location_id}</p>
                    <p class="text-sm text-gray-600">${location.zone}</p>
                    <p class="text-xs text-gray-500">Pallet: ${location.pallet_id || 'N/A'}</p>
                </div>
                <div class="text-right">
                    <p class="text-lg font-semibold text-blue-600">${location.stock.toLocaleString()}</p>
                    <p class="text-xs text-gray-500">ชิ้น</p>
                </div>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = locationsHTML;
    document.getElementById('sourceLocationContainer').classList.remove('hidden');
}

function selectSourceLocation(locationId, availableStock, palletId, zone) {
    selectedSourceLocation = { locationId, availableStock, palletId, zone };
    
    // Update UI
    document.querySelectorAll('.source-location-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    document.querySelector(`[data-location="${locationId}"]`).classList.add('selected');
    
    // Update source info display
    document.getElementById('sourceLocationId').textContent = locationId;
    document.getElementById('sourceStockAmount').textContent = `${availableStock.toLocaleString()} ชิ้น`;
    document.getElementById('sourcePalletId').textContent = palletId;
    
    document.getElementById('selectedSourceInfo').classList.remove('hidden');
    
    // Set max quantity
    const piecesInput = document.getElementById('movePieces');
    piecesInput.max = availableStock;
    piecesInput.placeholder = `สูงสุด ${availableStock.toLocaleString()} ชิ้น`;
    
    updateMovementSummary();
}

function loadDestinationLocations() {
    googleScriptCall('getAvailableLocations')
        .then(response => {
            if (response.success) {
                availableDestinations = response.data || [];
                displayDestinationLocations(availableDestinations);
            } else {
                console.error('Failed to load destinations:', response.message);
                displayDestinationsError();
            }
        })
        .catch(error => {
            console.error('Destinations loading error:', error);
            displayDestinationsError();
        });
}

function displayDestinationLocations(locations) {
    const container = document.getElementById('destinationLocationsList');
    
    if (!locations || locations.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">ไม่มีตำแหน่งที่ว่าง</p>';
        return;
    }
    
    const locationsHTML = locations.map(location => `
        <div class="destination-location-item p-3 rounded-lg" 
             onclick="selectDestinationLocation('${location.location_id}', '${location.zone?.zone_name || 'Unknown'}', '${location.max_weight || 1000}', '${location.max_pallets || 1}')"
             data-destination="${location.location_id}">
            <div class="flex justify-between items-center">
                <div>
                    <p class="font-medium text-gray-900">${location.location_id}</p>
                    <p class="text-sm text-gray-600">${location.zone?.zone_name || 'Unknown Zone'}</p>
                </div>
                <div class="text-right">
                    <p class="text-sm text-green-600">ว่าง</p>
                    <p class="text-xs text-gray-500">${location.max_weight || 1000} กก.</p>
                </div>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = locationsHTML;
}

function displayDestinationsError() {
    const container = document.getElementById('destinationLocationsList');
    container.innerHTML = `
        <div class="text-center py-4 text-red-500">
            <p>เกิดข้อผิดพลาดในการโหลดตำแหน่งปลายทาง</p>
            <button onclick="loadDestinationLocations()" class="mt-2 px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                ลองใหม่
            </button>
        </div>
    `;
}

function filterDestinationLocations() {
    const zoneFilter = document.getElementById('destinationZoneFilter').value;
    
    let filteredLocations = availableDestinations;
    
    if (zoneFilter) {
        filteredLocations = availableDestinations.filter(location => 
            location.zone?.zone_type === zoneFilter || location.zone?.zone_name === zoneFilter
        );
    }
    
    displayDestinationLocations(filteredLocations);
}

function selectDestinationLocation(locationId, zoneName, maxWeight, maxPallets) {
    selectedDestinationLocation = { locationId, zoneName, maxWeight, maxPallets };
    
    // Update UI
    document.querySelectorAll('.destination-location-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    document.querySelector(`[data-destination="${locationId}"]`).classList.add('selected');
    
    // Update destination info display
    document.getElementById('destinationLocationId').textContent = locationId;
    document.getElementById('destinationZone').textContent = zoneName;
    document.getElementById('destinationCapacity').textContent = `${maxWeight} กก., ${maxPallets} พาเลท`;
    document.getElementById('destinationStatus').textContent = 'ว่าง';
    
    document.getElementById('selectedDestinationInfo').classList.remove('hidden');
    
    updateMovementSummary();
}

function autoCalculateMovementWeight() {
    if (!selectedMoveProduct) return;
    
    const pieces = parseFloat(document.getElementById('movePieces').value) || 0;
    const weightPerPiece = selectedMoveProduct.weightPerBag || 0;
    
    if (pieces > 0 && weightPerPiece > 0) {
        const totalWeight = pieces * weightPerPiece;
        document.getElementById('moveWeight').value = totalWeight.toFixed(3);
    }
}

function updateMovementSummary() {
    if (!selectedSourceLocation || !selectedDestinationLocation) {
        document.getElementById('movementSummary').classList.add('hidden');
        return;
    }
    
    const pieces = parseFloat(document.getElementById('movePieces').value) || 0;
    
    if (pieces > 0) {
        document.getElementById('summaryFrom').textContent = selectedSourceLocation.locationId;
        document.getElementById('summaryQuantity').textContent = `${pieces.toLocaleString()} ชิ้น`;
        document.getElementById('summaryTo').textContent = selectedDestinationLocation.locationId;
        
        document.getElementById('movementSummary').classList.remove('hidden');
    } else {
        document.getElementById('movementSummary').classList.add('hidden');
    }
}

function handleMovementSubmit(event) {
    event.preventDefault();
    
    if (!selectedMoveProduct) {
        showMessage('กรุณาเลือกสินค้าก่อน', 'error');
        return;
    }
    
    if (!selectedSourceLocation) {
        showMessage('กรุณาเลือกตำแหน่งต้นทาง', 'error');
        return;
    }
    
    if (!selectedDestinationLocation) {
        showMessage('กรุณาเลือกตำแหน่งปลายทาง', 'error');
        return;
    }

    // Validate required fields
    const pieces = parseFloat(document.getElementById('movePieces').value) || 0;
    const reason = document.getElementById('movementReason').value;

    if (pieces <= 0) {
        showMessage('กรุณากรอกจำนวนที่ย้ายที่ถูกต้อง', 'error');
        return;
    }

    if (pieces > selectedSourceLocation.availableStock) {
        showMessage(`จำนวนที่ย้ายเกินสต๊อกคงเหลือ (${selectedSourceLocation.availableStock.toLocaleString()} ชิ้น)`, 'error');
        return;
    }

    if (!reason) {
        showMessage('กรุณาเลือกเหตุผลในการย้าย', 'error');
        return;
    }

    // Show loading state
    setMoveSubmitLoading(true);

    // Create two transactions: one for outgoing from source, one for incoming to destination
    const outgoingTransaction = {
        sku: selectedMoveProduct.sku,
        main_type: 'ย้ายสินค้า',
        sub_type: 'ย้ายออกจาก ' + selectedSourceLocation.locationId,
        pieces: -pieces, // Negative for outgoing
        weight: -(parseFloat(document.getElementById('moveWeight').value) || 0),
        location_id: selectedSourceLocation.locationId,
        pallet_id: selectedSourceLocation.palletId !== 'N/A' ? selectedSourceLocation.palletId : null,
        remark: `ย้ายไป ${selectedDestinationLocation.locationId} - ${reason}. ${document.getElementById('moveRemark').value || ''}`,
        status: 'ปกติ'
    };

    // Submit outgoing transaction first
    googleScriptCall('createTransaction', outgoingTransaction)
        .then(response => {
            if (response.success) {
                // Create incoming transaction
                const incomingTransaction = {
                    sku: selectedMoveProduct.sku,
                    main_type: 'ย้ายสินค้า',
                    sub_type: 'ย้ายเข้า ' + selectedDestinationLocation.locationId,
                    pieces: pieces, // Positive for incoming
                    weight: parseFloat(document.getElementById('moveWeight').value) || 0,
                    location_id: selectedDestinationLocation.locationId,
                    pallet_id: document.getElementById('newPalletId').value || selectedSourceLocation.palletId,
                    remark: `ย้ายจาก ${selectedSourceLocation.locationId} - ${reason}. ${document.getElementById('moveRemark').value || ''}`,
                    status: 'ปกติ'
                };

                return googleScriptCall('createTransaction', incomingTransaction);
            } else {
                throw new Error(response.message);
            }
        })
        .then(response => {
            if (response.success) {
                showMessage('ย้ายสินค้าเรียบร้อยแล้ว', 'success');
                resetMovementForm();
                loadMovementStats();
                loadRecentMovements();
                loadDestinationLocations(); // Refresh available locations
            } else {
                showMessage('เกิดข้อผิดพลาดในการสร้างธุรกรรมรับ: ' + response.message, 'error');
            }
        })
        .catch(error => {
            console.error('Movement submission error:', error);
            showMessage('เกิดข้อผิดพลาด: ' + error.message, 'error');
        })
        .finally(() => {
            setMoveSubmitLoading(false);
        });
}

function setMoveSubmitLoading(isLoading) {
    const button = document.querySelector('#itemMoveForm button[type="submit"]');
    const text = document.getElementById('moveSubmitText');
    const spinner = document.getElementById('moveSubmitSpinner');
    
    if (button) button.disabled = isLoading;
    if (text) text.textContent = isLoading ? 'กำลังดำเนินการ...' : 'ดำเนินการย้ายสินค้า';
    if (spinner) {
        if (isLoading) {
            spinner.classList.remove('hidden');
        } else {
            spinner.classList.add('hidden');
        }
    }
}

function resetMovementForm() {
    // Clear form
    document.getElementById('itemMoveForm').reset();
    
    // Clear selected items
    clearMoveSelectedProduct();
    
    showMessage('รีเซ็ตฟอร์มเรียบร้อย', 'success');
}

function loadMovementStats() {
    // For now, show static data
    document.getElementById('todayMovementCount').textContent = '5';
    document.getElementById('availableLocations').textContent = '12';
    document.getElementById('palletsMoved').textContent = '3';
    document.getElementById('pendingReorganize').textContent = '8';
}

function loadRecentMovements() {
    googleScriptCall('getTransactions', { 
        main_type: 'ย้ายสินค้า', 
        limit: 10 
    })
        .then(response => {
            if (response.success) {
                displayRecentMovements(response.data || []);
            } else {
                console.error('Failed to load recent movements:', response.message);
                displayMovementsError();
            }
        })
        .catch(error => {
            console.error('Recent movements loading error:', error);
            displayMovementsError();
        });
}

function displayRecentMovements(movements) {
    const tbody = document.getElementById('recentMovementsTableBody');
    
    if (!movements || movements.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                    <i class="fas fa-inbox text-xl mb-2"></i>
                    <p>ไม่มีการย้ายล่าสุด</p>
                </td>
            </tr>
        `;
        return;
    }

    const rows = movements.map(movement => {
        const createdAt = new Date(movement.created_at);
        const timeStr = createdAt.toLocaleTimeString('th-TH', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });

        // Extract location info from remark
        const remark = movement.remark || '';
        const fromMatch = remark.match(/ย้ายจาก ([A-Z0-9-]+)/);
        const toMatch = remark.match(/ย้ายไป ([A-Z0-9-]+)/);
        const reasonMatch = remark.match(/- (.+?)\./);
        
        const fromLocation = fromMatch ? fromMatch[1] : (movement.transaction_types?.sub_type?.includes('ออกจาก') ? movement.warehouse_locations?.location_id : 'N/A');
        const toLocation = toMatch ? toMatch[1] : (movement.transaction_types?.sub_type?.includes('เข้า') ? movement.warehouse_locations?.location_id : 'N/A');
        const reason = reasonMatch ? reasonMatch[1] : 'N/A';

        return `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${timeStr}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                    ${movement.products?.sku || 'N/A'}
                </td>
                <td class="px-6 py-4 text-sm text-gray-900">
                    ${movement.products?.product_name || 'N/A'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${fromLocation}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${toLocation}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${Math.abs(movement.pieces || 0).toLocaleString()} ชิ้น
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${reason}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${movement.users?.full_name || movement.created_by_name || 'N/A'}
                </td>
            </tr>
        `;
    }).join('');

    tbody.innerHTML = rows;
}

function displayMovementsError() {
    const tbody = document.getElementById('recentMovementsTableBody');
    tbody.innerHTML = `
        <tr>
            <td colspan="8" class="px-6 py-8 text-center text-red-500">
                <i class="fas fa-exclamation-triangle text-xl mb-2"></i>
                <p>เกิดข้อผิดพลาดในการโหลดข้อมูล</p>
                <button onclick="loadRecentMovements()" class="mt-2 px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                    ลองใหม่
                </button>
            </td>
        </tr>
    `;
}

function bulkMovement() {
    showMessage('ฟังก์ชันย้ายหลายรายการกำลังพัฒนา', 'info');
}

function viewMovementHistory() {
    loadPage('transactions');
}
</script>
